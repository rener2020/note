# 函数拆分
2023-12-20


## 跟踪参考关键帧 TrackReferenceKeyFrame
若运动模型是空的且IMU未初始化，或者刚完成重定位，则跟踪参考关键帧
1. 搜索匹配当前参考关键帧和当前帧的特征点
2. 特征点>15
3. 上一帧位姿作为当前帧初始位姿
4. PoseOptimization
5. 清除外点



## 只优化图像帧的位姿，利用3D-2D重投影误差 PoseOptimization

使用g2o优化图像帧的位姿
1. 设置线性求解器
2. 设置块求解器
3. 设置优化方式
4. 求解器初始化完成
5. 添加顶点：当前图像帧六维位姿（优化变量）
6. 定义一元边：3D-2D匹配误差边
7. 定义信息矩阵，层数越高，观测误差可能越大，则设置越小的信息矩阵，减少对整体系统的影响
8. 设置鲁棒核函数
9. 匹配点不足，放弃优化
10. 4次迭代优化，每次迭代次数为10，在迭代的过程中根据误差动态调整内点外点
11. 第二次优化后因为误差较小，去除误差核函数
12. 得到优化后的图像帧位姿


## 跟踪恒速模型 TrackWithMotionModel
若运动模型不是空的或IMU已经初始化，且不是刚完成重定位，则跟踪参考关键帧
1. 设置上一个图像帧位置 UpdateLastFrame
2. 根据IMU或者恒速模型得到当前帧的初始位姿  
2. IMU刚初始化不久：用IMU来估计位姿 PredictStateIMU
3. IMU未初始化或者时间很久： 用恒速模型得到当前图像帧的初始位姿 $mVelocity*mLastFrame.mTcw$
4. 初始化当前帧地图点

## 根据IMU或者恒速模型得到当前帧的初始位姿  PredictStateIMU
1. 提取上一帧位姿
2. 计算当前帧$R$
	1. $R = R_1R_2$
	2. $t = t +vt - 0.5gt^2 + R\Delta t$
	3. $v = v + gt + R\Delta v$

