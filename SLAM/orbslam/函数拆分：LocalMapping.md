# 函数拆分：LocalMapping
2024-01-02



## LocalMapping::run
1. 处理列表中的关键帧  ProcessNewKeyFrame
2. 对mlpRecentAddedMapPoints中的地图点进行检测和剔除 MapPointCulling
3. 通过三角化恢复新的地图点 CreateNewMapPoints
4. 融合当前关键帧和相邻关键帧中重复的地图点 SearchInNeighbors
5. 


## 通过三角化恢复新的地图点 CreateNewMapPoints
1. 获取共视程度最高的n个关键帧
2. 如果是IMU模式，则添加更多的关键帧存入附近关键帧，添加逻辑为：将不大于n个关键帧的前一关键帧加入获取关键帧
3. 如果基线长度/场景深度<0.01，则跳过
4. 计算当前关键帧和周围关键帧的基础矩阵F
5. 对当前处理的关键帧和周围一关键帧进行三角化搜索特征 SearchForTriangulation
6. 对每对成功匹配点三角化（线性三角化SVD）生成地图点
7. 检查三角化，是否正面、投影误差
8. 检查尺度比例与帧金字塔层尺度比例是否一致
9. 构建新3d点

## 三角化搜索特征 SearchForTriangulation
搜索特征点对应关系
1. 相机1在2上的投影距离匹配特征点不要太近
2. 匹配距离检查
3. 极线距离检查

## 地图点进行检测和剔除 MapPointCulling
剔除逻辑
1. 坏点
2. 已经被观测到帧/应该被观测到帧 < 0.25
3. 被超过两个关键帧跟踪但是观测到此地图点帧个数未达到阈值

## ProcessNewKeyFrame
1. 选取队列中第一个并将暂时其移出队列
2. 遍历当前关键帧的地图点
3. 如果地图点的观测是否存在当前关键帧：
	1. 不存在：地图点添加观测三部曲：添加-更新平均观测方向和深度（UpdateNormalAndDepth）-更新描述子（ComputeDistinctiveDescriptors）
	2. 存在：暂存入近期增加的地图点集合中，等待后续查验
4. 更新共视图：UpdateConnections
5. 将此关键帧加入当前地图中

## 更新平均观测方向和深度 UpdateNormalAndDepth
1. 遍历所有地图点的可观测帧
2. **平均观测方向**为获取地图点指向可观测帧相机中心的向量，相加并取平均
3. 获取此地图点第一次创建时的关键帧
4. 计算地图点到此关键帧的深度距离（位置到光心）
5. 获取地图点在此关键帧中的金字塔层数
6. 获取尺度因子和金字塔最高层的尺度因子
7. 计算**可观测到该点的距离上限下限** = dist\*factor

## 更新描述子 ComputeDistinctiveDescriptors
一个地图点可以被n个关键帧观测到，在每个关键帧中都有一个其orb描述子，获取其一个与其他描述子距离最小的描述子作为代表描述子

## 更新共视图：UpdateConnections
1. 获取当前关键帧地图点，根据地图点观测度重合程度与其他关键帧建立边
2. 剔除小于阈值的边，只保留大于阈值或者阈值之下最大的边
3. 如果未初始化，则初始化为连接权重最大的边