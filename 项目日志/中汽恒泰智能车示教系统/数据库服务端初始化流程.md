---
title: 数据库服务端初始化流程
tags: 新建,模板,小书匠
renderNumberedHeading: true
grammar_cjkRuby: true
---

### 概述
数据库服务端主要功能是接受控制端请求并返回处理后内容。
数据库服务端的底层通讯逻辑基于庄工写的[socket通讯模块](http://192.168.10.106:8080/project/3?p=92)。
1. 接收[客户端请求](http://192.168.10.106:8080/project/3?p=273)包
2. 判断请求包是否为字典
3. 判断请求包是否有`action`键
4. 判断请求包`action`的值是否处于动作字典中
5. 判断请求包是否有`info`
6. 处理响应信息，生成返回包
7. 将返回包通过[socket通讯](http://192.168.10.106:8080/project/3?p=92)传输到客户端


### 具体逻辑

服务端在初始化具体流程如下：
1. 服务端开启一个线程运行socket服务，注册全局回调函数
	```py
	if __name__ == '__main__':
		# ！！！
		# 开发环境
		DEBUG = True

		# ！！！
		# 生产环境
		# del DEBUG
		# DEBUG = False
		# start_server_communication()
		start_server(process_client_request, './config/config_cloud.json')
	```
	`start_server`函数如下：
	```py
	# app/communication/cloud_skt_server.py
	def start_server(hook_func, config_path):
		HookFunc.funcs.append(hook_func)
		# 外部参数加载
		setting = loadConfig(config_path)
		tcp_server_host = setting['cloud_tcp_server_host']
		tcp_server_port = setting['cloud_tcp_server_port']
		print(tcp_server_host, tcp_server_port)
		cloud_server = CloudThreadingTCPServer((tcp_server_host, tcp_server_port), ServersHandleCloud)
		css_handle = dict()
		css_handle["cloud_server"] = cloud_server
		cloud_skt_server_run(css_handle)
	```
	在这个函数中，`HookFunc.funcs.append(hook_func)`将回调函数注册到`HookFunc`类中的变量中，在这里注册的回调函数会在以下语句中用到，完成通讯过程中的处理任务回调。
	```py
	# app/communication/cloud_skt_server.py
	class ServersHandleCloud(StreamRequestHandler, FFFEPkgParser):  # ,FFFEPkgParser
		... ...
		def run_hook_funcs(self, json_data):
			for f in HookFunc.funcs:
				return f(self, json_data)
			... ...
		... ...
	```
	`run_hook_funcs`函数最终在数据接受完成之后调用。
	```py
	# app/communication/cloud_skt_server.py
	class ServersHandleCloud(StreamRequestHandler, FFFEPkgParser):  # ,FFFEPkgParser
		... ...
		def on_skt_data_ok(self, e):
			err, json_data = self.b64json_data.decodeFromPkg(e.data)
			if err == 0:
				self.send_json_cmd(self.run_hook_funcs(json_data))
		... ...
	```
2. 服务端接受客户端请求，并通过全局回调处理客户端请求，并返回数据
	