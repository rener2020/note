---
title: 沙盘管理
tags: 新建,模板,小书匠
renderNumberedHeading: true
grammar_cjkRuby: true
---

# 显示沙盘动态
### 概述
1. 用户点击显示沙盘动态按钮
2. 系统访问[获取车辆当前运行数据接口](http://192.168.10.106:8080/project/3?p=304)，获取对应的车辆运行数据
3. 系统根据车辆运行数据进行[坐标变换，偏移校准](http://192.168.10.106:8080/project/3?p=301)，最终在沙盘上正确显示车辆
### 具体逻辑
用户点击沙盘动态时，会触发`self.ui.button_sandbox_start.clicked`信号。
``` py
# ui/admin.py
# 显示沙盘动态
self.ui.button_sandbox_start.clicked.connect(self.sand_box.start_sandbox)
```
同时`self.ui.button_sandbox_start.clicked`信号连接到`self.sand_box.start_sandbox`函数。

``` py
# ui/sandbox.py
    def start_sandbox(self):
        self.flag_sandbox_start = True
        if not self.flag_start_update_vehicles_running_data_service:
            start_thread_work(self.update_vehicles_running_data_service)
            self.flag_start_update_vehicles_running_data_service = True
```

`self.sand_box.start_sandbox`函数开启线程运行`self.update_vehicles_running_data_service`函数。

``` py
# ui/sandbox.py
    def update_vehicles_running_data_service(self):
        while True:
            time.sleep(0.1)
            if self.flag_sandbox_start:
                self.update_vehicles_running_data()
```

`self.update_vehicles_running_data_service`函数调用`self.update_vehicles_running_data`函数

``` py
# ui/sandbox.py
    def update_vehicles_running_data(self):
        for vehicle_id in self.vehicles:
            state, result = server_communication.communicate({
                'action': 'admin_get_vehicle_current_running_data',
                'info': {
                    'vehicle_id': vehicle_id
                }
            })
            if state and result['state']:
                self.update_vehicle_running_data(self.vehicles[vehicle_id], result['info'])
                if self.master.selected_vehicle and 'id' in self.master.selected_vehicle:
                    if vehicle_id == self.master.selected_vehicle['id']:
                        self.master.update_selected_vehicle_status(result['info'])
        pass
```