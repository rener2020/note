---
title: 车端日志
tags: 新建,模板,小书匠
renderNumberedHeading: true
grammar_cjkRuby: true
---


### 概述
车端日志功能是用来记录、显示车端操作过程的一个界面。
其工作流程如下：
1. [车端界面初始化](http://192.168.10.106:8080/project/3?p=250)
2. 车端日志界面初始化
3. 系统记录车端运行日志
3. 显示车端日志界面
4. 车端初始化完成，关闭车端日志界面
5. 用户点击查看日志按钮，显示车端日志界面
6. 用户点击关闭车端日志界面

### 具体逻辑
在初始化车端界面时，会初始化车端日志界面。

``` py
# ui/VehicleUi.py
# 日志界面
# 日志界面界面初始化
self.log_dialog = LogDialog()
```

同时会显示车端日志界面

``` py
# ui/VehicleUi.py
# 显示gui
self.log_dialog.show()
```

车端日志的记录功能由`signal_write_log`信号触发

``` py
# ui/VehicleUi.py
# 写入日志信号
signal_write_log = pyqtSignal(str, name='signal_write_log')
```

此信号被连接到`self.write_log`函数

``` py
# ui/VehicleUi.py
def register_all(self):
	"""
	绑定按钮，事件等
	"""
	... ...
	# 写入日志信号
	self.signal_write_log.connect(self.write_log)
	... ...
```

`self.write_log`函数调用了`self.log_dialog.log`函数

``` py
# ui/VehicleUi.py
def write_log(self, log_content):
	self.log_dialog.log(log_content)
```

`self.log_dialog.log`函数如下，最终写入日志的函数也就是这个函数：

``` py
# ui/ui.py
    def log(self, massage):
        self.ui.text_log.append(
            "<html><head/><body><p align=\"\"><span style=\" font-size:18pt;\">{}</span></p></body></html>".format(
                str(massage)
            )
        )
```

在实际程序中，使用`sim_log`函数标准化日志格式。如：

``` py
# # ui/VehicleUi.py
    def get_ip_address(self):
        ip_address = get_host_ip()
        self.signal_write_log.emit(sim_log('正在获取当前机器ip地址'))
        if not ip_address:
            self.signal_write_log.emit(sim_log('无法获取当前机器ip地址'))
        self.signal_write_log.emit(sim_log('获取当前机器ip地址成功，ip地址为：{}'.format(ip_address)))
        return ip_address
```

`sim_log`函数会标准化日志信息，在终端输出并返回标准化之后的日志信息。

``` py
# ui/ui.py
def sim_log(info):
    # 获得当前时间
    str_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime(time.time()))
    # 调用者文件名
    file_name = sys._getframe().f_back.f_code.co_filename
    # 调用者函数名
    co_name = sys._getframe().f_back.f_code.co_name
    # 调用者所在行号
    f_line_no = sys._getframe().f_back.f_lineno
    log_info = "{},{},{},{},{}".format(str_time, file_name, co_name, f_line_no, info)
    print log_info
    return log_info
```