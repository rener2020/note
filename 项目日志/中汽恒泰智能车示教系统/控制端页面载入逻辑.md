---
title: 控制端页面载入逻辑
tags: 
renderNumberedHeading: true
grammar_cjkRuby: true
---


控制端的入口文件为`main.py`,控制端可分为脱机模式和在线模式，具体代码在`main.py`第109行查看：

``` python
    def main_logic_loop(self):
        offline = True
        if offline:
            # 离线模式
            self.user_info['user_type'] = 'student'
            self.user_info['user_type'] = 'teacher'
            self.user_info['user_type'] = 'admin'
            self.user_info['user_code'] = '-1'
            self.signal_load_main_window.emit()
            return
        # 在线模式
```

在线模式启动流程图如下：
```flow
st=>start: 开始
e=>end: 结束
op9=>operation: 开启希望函数
op0=>operation: 载入验证mac界面，验证mac地址
op1=>operation: 载入登录界面
op2=>operation: 用户登录
op3=>operation: 获取用户信息
op4=>operation: 根据用户信息载入主界面
op=>operation: 在
cond1=>condition: mac地址验证成功？
cond2=>condition: 登录成功？
cond3=>condition: 签名是否正确？
st->op9->op0->cond1
cond1(no)->cond1
cond1(yes)->op1->op2->cond2
cond2(no)->op2
cond2(yes)->op3->op4
op4->e
```
希望函数与[系统异常处理退出逻辑](http://192.168.10.106:8080/project/3?p=296)有关
# 系统异常处理退出逻辑有关
系统除了主进程之外，还会开启子进程，可能由于某些特殊原因，子进程的退出不能由主进程控制，为了处理这种异常，构建了一套了检查时间戳退出模式，这种模式由两个函数构成。
- 希望函数：每隔一段时间往`cache.txt`里面写入当前时间戳：
	``` py
	# app/utils.py
	def hope():
		if hasattr(hope, 'hope'):
			return
		setattr(hope, 'hope', 'hope')
		while True:
			time.sleep(0.5)
			with open('cache.txt', 'w') as f:
				f.write(str(time.time()))
	```
- 死亡函数，每隔一段时间对`cache.txt`中的时间戳进行检查：
	``` py
	# app/utils.py
	def should_i_die():
		try:
			with open('cache.txt', 'r') as f:
				_hope = f.readline()
			if time.time() - float(_hope.strip()) > 2:
				return True
		except:
			return True
		return False
	```

希望函数由主进程的主线程开启，死亡函数由子进程使用并检查主进程是否退出，若主进程退出执行异常处理动作，如：
```py
# app/ros/vehicle.py
            if should_i_die():
                # 车辆ros节点自退出
                self.event_stop.clear()
                #
                rospy.signal_shutdown("出现严重错误，车辆节点终止，结束进程！")
                # 如果获取到终止信号，则退出进程
                sim_log('出现严重错误，车辆节点终止，结束进程！')
                break
```