---
title: 车辆管理
tags: 新建,模板,小书匠
renderNumberedHeading: true
grammar_cjkRuby: true
---

# 车辆管理
车辆管理主界面如下
![主界面](./images/主界面.png)
### 重启车载系统

车辆自检按钮在`ui/student.py`中的`register_all`函数中进行信号连接，其点击事件连接到`self.restart_vehicle_node`函数，`self.restart_vehicle_node`函数又调用了`self.restart_vehicle_dialog.restart_vehicle`函数，而`self.restart_vehicle_dialog`是`RestartVehicleDialog`的一个实例。

``` py
# ui/student.py 257行
# 重启车辆界面
self.restart_vehicle_dialog = RestartVehicleDialog(self)
```

``` py
# ui/student.py 415行
# 重启车端系统按钮
self.ui.button_restart_vehicle_system.clicked.connect(self.restart_vehicle_node)
```

``` py
def restart_vehicle_node(self):
	# 重启车端系统
	self.restart_vehicle_dialog.restart_vehicle()
```
重启车辆系统的界面如下：
![重启车载系统](./images/重启车载系统.png)
确定按钮点击信号连接到`self.restart_vehicle_submit`函数上。

``` py
    def register_all(self):
        self.submit.clicked.connect(self.restart_vehicle_submit)
        self.cancel.clicked.connect(self.restart_vehicle_cancel)
```
`self.restart_vehicle_submit`函数会触发`self.restart_process.signal_restart_vehicle`信号。

``` py
    def restart_vehicle_submit(self):
        self.restart_process.signal_restart_vehicle.emit()
        self.hide()
```
`self.restart_process.signal_restart_vehicle`被连接到`self.restart_vehicle`函数，并最终执行。

``` py
# ui/vehicle_management/restart_vehicle.py 82 行
    def register_all(self):
        self.submit.clicked.connect(self.close)
        # self.cancel.clicked.connect(self.hide)
        self.signal_restart_vehicle.connect(self.restart_vehicle)
        self.signal_set_text.connect(self.set_text)
        self.signal_progress_i.connect(self.progress_i)
```

``` py
# ui/vehicle_management/restart_vehicle.py 39 行
    def restart_vehicle(self):
		... ...
```

在`self.restart_vehicle`函数执行时，会调用车端服务接口与数据库服务端接口，其基本逻辑为：
1. 调用车端服务端接口`car_sys_restart`
   - 若成功则调用数据库服务端接口[student_stop_vehicle_system](http://192.168.10.106:8080/project/3?p=160)再调用[student_start_vehicle_system](http://192.168.10.106:8080/project/3?p=161)
   - 若失败则显示相应的信息

其对应代码如下：

``` py
# ui/vehicle_management/restart_vehicle.py 45行
state, result = vehicle_communication.communicate({
	'action': 'car_sys_restart'
})
if state:
	self.signal_set_text.emit("车载系统已经重启启动！")
	print server_communication.communicate({
		'action': 'student_stop_vehicle_system',
		'info': {
			'vehicle_id': self.master.vehicle_info['id'],
			'terminal_mac': self.master.terminal_mac,
			'user_code': self.master.user_info['user_code'],
			'close_time': datetime_now(),
		}
	})
	server_communication.communicate({
		'action': 'student_start_vehicle_system',
		'info': {
			'vehicle_id': self.master.vehicle_info['id'],
			'terminal_mac': self.master.terminal_mac,
			'user_code': self.master.user_info['user_code'],
			'start_time': datetime_now(),
		}
	})
	sim_log("车载系统已经重启启动！")
else:
	self.signal_set_text.emit("未能成功重启车辆")
	sim_log("未能成功重启车辆")
```

![重启完成](./images/重启完成.png)

### 关闭车载系统

### 运行状态自检
### 运行日志

# 沙盘管理
### 显示沙盘动态
### 关闭沙盘动态
### 沙盘实景演示